name: "Flutter CI Reusable Workflow"

on:
  workflow_call:
    inputs:
      flutter_version:
        required: false
        type: string
        default: '3.32.0'

      flutter_channel:
        required: false
        type: string
        default: 'stable'

      coverage_threshold:
        required: false
        type: string
        default: '80'

      build_ios:
        required: false
        type: boolean
        default: false

    secrets:
      SONAR_TOKEN:
        required: false
      CODACY_PROJECT_TOKEN:
        required: false
      ANDROID_KEYSTORE:
        required: false
      KEYSTORE_PASSWORD:
        required: false
      KEY_PASSWORD:
        required: false
      KEY_ALIAS:
        required: false

env:
  FLUTTER_VERSION: ${{ inputs.flutter_version }}
  FLUTTER_CHANNEL: ${{ inputs.flutter_channel }}
  COVERAGE_THRESHOLD: ${{ inputs.coverage_threshold }}

jobs:
  # ---------------------------------------------------------------------------
  # BUILD SETUP
  # ---------------------------------------------------------------------------
  build_flutter_project:
    name: Setup Flutter Project
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set Up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Setup Flutter
        uses: Darryl-Cardoza/flutter-reusable-repo/.github/actions/setup-flutter@main
        with:
          flutter_version: ${{ inputs.flutter_version }}
          flutter_channel: ${{ inputs.flutter_channel }}

      - name: Flutter Pub Get
        run: flutter pub get

  # ---------------------------------------------------------------------------
  # ANALYZER
  # ---------------------------------------------------------------------------
  dart_analyzer:
    name: Run Dart Analyzer
    runs-on: ubuntu-latest
    needs: build_flutter_project

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: Darryl-Cardoza/flutter-reusable-repo/.github/actions/setup-flutter@main
        with:
          flutter_version: ${{ inputs.flutter_version }}
          flutter_channel: ${{ inputs.flutter_channel }}

      - name: Run Dart Analyzer
        run: |
          dart analyze > analyzer-report.txt || true
          if grep -q "error •" analyzer-report.txt; then
            echo "❌ Dart analyzer errors found"
            exit 1
          fi

      - name: Upload Analyzer Report
        uses: actions/upload-artifact@v4
        with:
          name: Dart-Analyzer-Reports
          path: analyzer-report.txt

  # ---------------------------------------------------------------------------
  # TESTS
  # ---------------------------------------------------------------------------
  run_tests:
    name: Run Flutter Tests
    runs-on: ubuntu-latest
    needs: build_flutter_project

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: Darryl-Cardoza/flutter-reusable-repo/.github/actions/setup-flutter@main
        with:
          flutter_version: ${{ inputs.flutter_version }}
          flutter_channel: ${{ inputs.flutter_channel }}

      - name: Run Tests
        run: flutter test --coverage || true

  # ---------------------------------------------------------------------------
  # ANDROID BUILD (DEBUG OR RELEASE)
  # ---------------------------------------------------------------------------
  build_android:
    name: Build Android (Debug / Release)
    runs-on: ubuntu-latest
    needs: [dart_analyzer, run_tests]

    steps:
      - uses: actions/checkout@v4

      - name: Set Up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Setup Flutter
        uses: Darryl-Cardoza/flutter-reusable-repo/.github/actions/setup-flutter@main
        with:
          flutter_version: ${{ inputs.flutter_version }}
          flutter_channel: ${{ inputs.flutter_channel }}

      # ----------------------------
      # Detect Keystore
      # ----------------------------
      - name: Check Keystore Availability
        id: keystore_check
        run: |
          if [ -z "${{ secrets.ANDROID_KEYSTORE }}" ]; then
            echo "has_keystore=false" >> $GITHUB_OUTPUT
            echo "⚠️ No keystore found. Building DEBUG APK."
          else
            echo "has_keystore=true" >> $GITHUB_OUTPUT
            echo "✅ Keystore found. Building RELEASE AAB."
          fi

      # ----------------------------
      # RELEASE BUILD (SIGNED)
      # ----------------------------
      - name: Decode Android Keystore
        if: steps.keystore_check.outputs.has_keystore == 'true'
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > android/upload-keystore.jks

      - name: Create key.properties
        if: steps.keystore_check.outputs.has_keystore == 'true'
        run: |
          cat <<EOF > android/key.properties
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=upload-keystore.jks
          EOF

      - name: Build RELEASE AAB
        if: steps.keystore_check.outputs.has_keystore == 'true'
        run: flutter build appbundle --release

      # ----------------------------
      # DEBUG BUILD (NO KEYSTORE)
      # ----------------------------
      - name: Build DEBUG APK
        if: steps.keystore_check.outputs.has_keystore == 'false'
        run: flutter build apk --debug

      # ----------------------------
      # Upload Artifacts
      # ----------------------------
      - name: Upload Android Build Output
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            build/app/outputs/bundle/release/*.aab
            build/app/outputs/flutter-apk/app-debug.apk
