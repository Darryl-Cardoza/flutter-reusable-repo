name: "Reusable Flutter CI"

on:
  workflow_call:
    inputs:
      flutter_version:
        required: true
        type: string
      flutter_channel:
        required: true
        type: string
      coverage_threshold:
        required: true
        type: string
      build_ios:
        required: false
        type: boolean
        default: false
    secrets:
      SONAR_TOKEN:
        required: false
      CODACY_PROJECT_TOKEN:
        required: false
      GITHUB_TOKEN:
        required: false

jobs:
  analyze_and_test:
    name: Analyze & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ inputs.flutter_version }}
          channel: ${{ inputs.flutter_channel }}
          cache: true 

      - name: Install Dependencies
        run: flutter pub get

      - name: Run Dart Analyzer
        run: dart analyze > analyzer-report.txt

      - name: Upload Analyzer Report
        uses: actions/upload-artifact@v4
        with:
          name: analyzer-report
          path: analyzer-report.txt

      - name: Run Tests and Generate Coverage
        run: flutter test --coverage

      - name: Upload Coverage Info
        uses: actions/upload-artifact@v4
        with:
          name: coverage-info
          path: coverage/lcov.info

  check_coverage:
    name: Verify Test Coverage
    needs: analyze_and_test
    runs-on: ubuntu-latest
    steps:
      - name: Download Coverage Info
        uses: actions/download-artifact@v4
        with:
          name: coverage-info
          path: .

      - name: Install lcov
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Check Coverage Threshold
        run: |
          total_coverage=$(lcov --summary lcov.info | grep -Po 'lines\.*: \K[0-9.]+(?=%)')
          echo "Total Coverage: $total_coverage%"
          if (( $(echo "$total_coverage < ${{ inputs.coverage_threshold }}" | bc -l) )); then
            echo "Error: Code coverage ($total_coverage%) is below the required threshold of ${{ inputs.coverage_threshold }}%."
            exit 1
          else
            echo "Success: Code coverage meets the threshold."
          fi

  security_analysis:
    name: Security & Quality Analysis
    needs: analyze_and_test
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter (for pub)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ inputs.flutter_version }}
          channel: ${{ inputs.flutter_channel }}
          cache: true

      - name: Download Coverage Info
        uses: actions/download-artifact@v4
        with:
          name: coverage-info
          path: .

      - name: Run SonarCloud Scan
        if: secrets.SONAR_TOKEN != ''
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=your-sonar-org
            -Dsonar.projectKey=your-project-key
            -Dsonar.sources=lib
            -Dsonar.tests=test
            -Dsonar.dart.coverage.lcovReportPath=lcov.info

      - name: Run Codacy Scan
        if: secrets.CODACY_PROJECT_TOKEN != ''
        uses: codacy/codacy-analysis-cli-action@v4
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: lcov.info

  build_android:
    name: Build Android APK
    needs: [check_coverage, security_analysis]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ inputs.flutter_version }}
          channel: ${{ inputs.flutter_channel }}
          cache: true

      - name: Install Dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --split-per-abi

      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-apk
          path: build/app/outputs/flutter-apk/

  build_ios:
    name: Build iOS App
    if: ${{ inputs.build_ios }}
    needs: [check_coverage, security_analysis]
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ inputs.flutter_version }}
          channel: ${{ inputs.flutter_channel }}
          cache: true

      - name: Install Dependencies
        run: flutter pub get

      - name: Build iOS IPA
        run: flutter build ipa --no-codesign

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-ipa
          path: build/ios/ipa/


