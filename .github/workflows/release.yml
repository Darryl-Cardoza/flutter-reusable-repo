name: "Reusable Flutter CD"

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string

      # ---------------- Cloud ----------------
      deploy_to_cloud:
        required: false
        type: boolean
        default: false

      enable_aws:
        required: false
        type: boolean
        default: false

      terraform_working_dir:
        required: false
        type: string
        default: './terraform'

      # ---------------- Play Store ----------------
      deploy_to_playstore:
        required: false
        type: boolean
        default: false

      playstore_track:
        required: false
        type: string
        default: internal

      playstore_status:
        required: false
        type: string
        default: completed

      package_name:
        required: true
        type: string

      playstore_metadata_path:
        required: false
        type: string
        default: playstore/metadata

      playstore_images_path:
        required: false
        type: string
        default: playstore/images

    secrets:
      AWS_ACCESS_KEY_ID:
        required: false
      AWS_SECRET_ACCESS_KEY:
        required: false
      AWS_SESSION_TOKEN:
        required: false
      PLAYSTORE_SERVICE_ACCOUNT:
        required: false

jobs:
  # ---------------------------------------------------------------------------
  # CREATE GITHUB RELEASE
  # ---------------------------------------------------------------------------
  create_release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version_check.outputs.version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: release

      - name: Determine Next GitHub Version
        id: version_check
        run: |
          BASE_VERSION="${{ inputs.version }}"
          git fetch --tags
          CURRENT_VERSION="${BASE_VERSION}"

          while git rev-parse "v${CURRENT_VERSION}" >/dev/null 2>&1; do
            IFS='.' read -r major minor patch <<<"${CURRENT_VERSION}"
            patch=$((patch + 1))
            CURRENT_VERSION="${major}.${minor}.${patch}"
          done

          echo "version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… GitHub Release Version: ${CURRENT_VERSION}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version_check.outputs.version }}
          name: Release v${{ steps.version_check.outputs.version }}
          generate_release_notes: true

      - name: Upload APK to GitHub Release (if exists)
        run: |
          apk=$(find release -name "*.apk" | head -n 1)
          if [ -n "$apk" ]; then
            gh release upload \
              v${{ steps.version_check.outputs.version }} \
              "$apk" \
              --clobber
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ---------------------------------------------------------------------------
  # DEPLOY TO AWS (OPTIONAL)
  # ---------------------------------------------------------------------------
  deploy_aws:
    if: ${{ inputs.deploy_to_cloud && inputs.enable_aws }}
    needs: create_release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "1.5.0"

      - run: terraform -chdir="${{ inputs.terraform_working_dir }}" init

      - run: |
          terraform -chdir="${{ inputs.terraform_working_dir }}" apply -auto-approve \
            -var="app_version=${{ needs.create_release.outputs.version }}"

  # ---------------------------------------------------------------------------
  # DEPLOY TO PLAY STORE
  # ---------------------------------------------------------------------------
  deploy_playstore:
    name: Deploy to Google Play Store
    if: ${{ inputs.deploy_to_playstore }}
    needs: create_release
    runs-on: ubuntu-latest

    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: release

      - name: Find AAB (skip if not found)
        id: bundle
        run: |
          bundle=$(find release -name "*.aab" | head -n 1)

          if [ -z "$bundle" ]; then
            echo "âš ï¸ No AAB found. Skipping Play Store deployment."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "bundle=$bundle" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      # -----------------------------------------------------------------------
      # Validate Play Store Access (Fail Fast)
      # -----------------------------------------------------------------------
      - name: Validate Play Store Configuration
        if: steps.bundle.outputs.skip == 'false'
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAYSTORE_SERVICE_ACCOUNT }}
          packageName: ${{ inputs.package_name }}
          track: ${{ inputs.playstore_track }}
          skipUpload: true

      # -----------------------------------------------------------------------
      # Upload AAB + Metadata + Images
      # -----------------------------------------------------------------------
      - name: Upload to Google Play Store
        if: steps.bundle.outputs.skip == 'false'
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAYSTORE_SERVICE_ACCOUNT }}
          packageName: ${{ inputs.package_name }}

          releaseFiles: ${{ steps.bundle.outputs.bundle }}

          track: ${{ inputs.playstore_track }}
          status: ${{ inputs.playstore_status }}

          # ðŸ”¥ Store listing automation
          metadataPath: ${{ inputs.playstore_metadata_path }}
          imagesPath: ${{ inputs.playstore_images_path }}

          inAppUpdatePriority: 2
